<div class="portfeuille-container">
  <div
    *ngIf="
      hasAnyInvestments || selectedState === 'Détails';
      else portefeuilleEmpty
    "
  >
    <div class="dashboard-cards">
      <app-card
        title="Total Investi"
        value="170 000 €"
        subtitle="Capital investi à ce jour"
      >
      </app-card>

      <app-card
        title="Rendement Moyen"
        subtitle="Sur l'ensemble des investissements"
      >
      </app-card>

      <app-card title="Revenu Mensuel" subtitle="Revenu net perçu"> </app-card>

      <app-card title="Cashback" subtitle="Jusqu'à maintenant"> </app-card>
    </div>

    <div>
      <p-tabView class="no-padding-tab-panel" (onChange)="onTabChange($event)">
        <p-tabPanel header="Acceptée"></p-tabPanel>
        <p-tabPanel header="En cours de traitement"></p-tabPanel>
        <p-tabPanel header="En attente de paiement"></p-tabPanel>
        <p-tabPanel header="Refusée"></p-tabPanel>
        <p-tabPanel header="Détails">
          <div *ngIf="showDetailsComponents">
            <ng-container
              *ngIf="
                investissements && investissements.length > 0;
                else noDataDetails
              "
            >
              <div class="container-pf-details">
                <p-card class="card-pf-map">
                  <app-map
                    [countries]="geographicalDistribution"
                    [mapHeight]="'520px'"
                  ></app-map>
                </p-card>
                <p-card class="card-pf-map">
                  <p-chart type="doughnut" [data]="sectorialData"></p-chart>
                </p-card>
              </div>
            </ng-container>

            <ng-template #noDataDetails>
              <div class="empty-card-container">
                <p-card class="empty-card">
                  <ng-template pTemplate="content">
                    <div class="text-center">
                      <i
                        class="pi pi-info-circle"
                        style="font-size: 2rem; color: #6c757d"
                      ></i>
                      <h3>Aucune donnée disponible</h3>
                      <p>
                        Il n'y a pas encore d'investissements pour afficher les
                        détails.
                      </p>
                    </div>
                  </ng-template>
                </p-card>
              </div>
            </ng-template>
          </div>

          <app-card
            style="display: none"
            (geographicalData)="onGeographicalDataReceived($event)"
          ></app-card>
          <app-card
            style="display: none"
            (sectorialData)="onSectorialDataReceived($event)"
          ></app-card>
        </p-tabPanel>
      </p-tabView>
      <p-table
        *ngIf="
          selectedState !== 'Détails' &&
          investissements &&
          investissements.length > 0
        "
        [value]="investissements"
        dataKey="id"
        [tableStyle]="{ 'min-width': '60rem' }"
        [expandedRowKeys]="expandedRows"
        (onRowExpand)="onRowExpand($event)"
        (onRowCollapse)="onRowCollapse($event)"
      >
        <ng-template #caption>
          <div class="flex flex-wrap justify-end gap-1">
            <p-button
              label="Étendre tout"
              icon="pi pi-plus"
              text
              (onClick)="expandAll()"
            />
            <p-button
              label="Réduire tout"
              icon="pi pi-minus"
              text
              (onClick)="collapseAll()"
            />
          </div>
        </ng-template>
        <ng-template #header>
          <tr>
            <th style="width: 5rem"></th>
            <th pSortableColumn="name">Nom SCPI <p-sortIcon field="name" /></th>
            <th>Image</th>
            <th pSortableColumn="price">
              Montant total <p-sortIcon field="price" />
            </th>
            <th pSortableColumn="category">
              Nombre de parts <p-sortIcon field="category" />
            </th>
            <th pSortableColumn="inventoryStatus">
              Status <p-sortIcon field="inventoryStatus" />
            </th>
          </tr>
        </ng-template>

        <ng-template #body let-investissement let-expanded="expanded" let-i="">
          <tr>
            <td>
              <button (click)="toggleRow(investissement)" class="toggle-btn">
                <i
                  [ngClass]="
                    expandedRows[investissement.id]
                      ? 'pi pi-chevron-down'
                      : 'pi pi-chevron-right'
                  "
                ></i>
              </button>
            </td>
            <td>{{ investissement.scpiName }}</td>
            <td>
              <img
                [src]="getInvestmentImage(investissement)"
                [alt]="investissement.scpiName"
                width="50"
                class="shadow-lg"
              />
            </td>
            <td>{{ investissement.totalAmount }} €</td>
            <td>{{ investissement.numberShares }}</td>
            <td>
              <p-tag
                [value]="
                  getInvestmentStateTranslate(investissement.investmentState)
                "
                [severity]="
                  getInvestmentSeverity(investissement.investmentState)
                "
              >
              </p-tag>
            </td>
          </tr>
        </ng-template>

        <ng-template #expandedrow let-investissement>
          <tr>
            <td colspan="7">
              <div class="p-4">
                <h5>Détails de {{ investissement.scpiName }}</h5>
                <p-table [value]="filteredInvestments" dataKey="scpiName">
                  <ng-template #header>
                    <tr>
                      <th pSortableColumn="id">
                        Type <p-sortIcon field="id" />
                      </th>
                      <th pSortableColumn="montant">
                        Montant <p-sortIcon field="montant" />
                      </th>
                      <th pSortableColumn="nbr">
                        Nombre de parts <p-sortIcon field="nbr" />
                      </th>
                      <th pSortableColumn="status">
                        Status <p-sortIcon field="status" />
                      </th>
                    </tr>
                  </ng-template>
                  <ng-template #body let-invest>
                    <tr>
                      <td>
                        {{ getInvestmentTypeTranslate(invest.typeProperty) }}
                      </td>
                      <td>{{ invest.totalAmount }} €</td>
                      <td>{{ invest.numberShares }}</td>
                      <td>
                        <p-tag
                          [value]="
                            getInvestmentStateTranslate(
                              investissement.investmentState
                            )
                          "
                          [severity]="
                            getInvestmentSeverity(
                              investissement.investmentState
                            )
                          "
                        >
                        </p-tag>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <div
        *ngIf="
          selectedState !== 'Détails' &&
          investissements &&
          investissements.length === 0
        "
        class="empty-card-container"
      >
        <div class="empty-card-container">
          <p-card class="empty-card">
            <ng-template pTemplate="content">
              <div class="text-center">
                <i
                  class="pi pi-info-circle"
                  style="font-size: 2rem; color: #6c757d"
                ></i>
                <h3>Aucun investissement</h3>
                <p>Il n'y a pas encore d'investissements pour cet état.</p>
              </div>
            </ng-template>
          </p-card>
        </div>
      </div>

      <p-paginator
        *ngIf="selectedState !== 'Détails'"
        [first]="currentPage * rows"
        [rows]="rows"
        [totalRecords]="totalRecords"
        [rowsPerPageOptions]="[5, 10, 20]"
        (onPageChange)="onPageChange($event)"
      >
      </p-paginator>
    </div>
  </div>
</div>

<ng-template #portefeuilleEmpty>
  <h3 class="note-txt">Votre portefeuille est vide</h3>
  <div class="page-container">
    <div class="card">
      <div>
        <h4 class="card-title">Votre portefeuille est vide</h4>
        <p class="card-body">
          Découvrez notre sélection de SCPI et profitez de 3,00 % de cashback
          sur la plupart d'entre elles.
        </p>
      </div>
      <br />
      <div class="btn-container">
        <p-button
          (click)="startInvesting()"
          label="Commencer à investir"
          icon="pi pi-arrow-right"
          severity="info"
        >
        </p-button>
      </div>
    </div>
  </div>
</ng-template>
